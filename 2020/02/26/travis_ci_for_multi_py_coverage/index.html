<!DOCTYPE html>
<html lang=en>
<head><meta name="generator" content="Hexo 3.9.0">
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="description" content="In the past few days, I was finding a solution for:  running tests with code coverage for a project targeting multiple Python versions automatically public and easily accessible coverage report  To me">
<meta name="keywords" content="note,ci">
<meta property="og:type" content="article">
<meta property="og:title" content="Hosting code coverage report for a project targeting multiple Python versions by Travis CI and Github Pages">
<meta property="og:url" content="https://naleraphael.github.io/2020/02/26/travis_ci_for_multi_py_coverage/index.html">
<meta property="og:site_name" content="Little things matter">
<meta property="og:description" content="In the past few days, I was finding a solution for:  running tests with code coverage for a project targeting multiple Python versions automatically public and easily accessible coverage report  To me">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2020-02-27T06:58:56.664Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Hosting code coverage report for a project targeting multiple Python versions by Travis CI and Github Pages">
<meta name="twitter:description" content="In the past few days, I was finding a solution for:  running tests with code coverage for a project targeting multiple Python versions automatically public and easily accessible coverage report  To me">
    
    
        
          
              <link rel="shortcut icon" href="/blog/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/blog/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>Hosting code coverage report for a project targeting multiple Python versions by Travis CI and Github Pages</title>
    <!-- styles -->
    <link rel="stylesheet" href="/blog/css/style.css">
    <!-- persian styles -->
    
      <link rel="stylesheet" href="/blog/css/rtl.css">
    
    <!-- rss -->
    
    
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/blog/">Home</a></li>
         
          <li><a href="/blog/about/">About</a></li>
         
          <li><a href="/blog/archives/">Writing</a></li>
         
          <li><a href="/blog/tags/">tags</a></li>
         
          <li><a href="/blog/search/">Search</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        
        <li><a class="icon" href="/blog/2019/10/01/ECMA-262-3_ch_4/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://naleraphael.github.io/2020/02/26/travis_ci_for_multi_py_coverage/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://naleraphael.github.io/2020/02/26/travis_ci_for_multi_py_coverage/&text=Hosting code coverage report for a project targeting multiple Python versions by Travis CI and Github Pages"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://naleraphael.github.io/2020/02/26/travis_ci_for_multi_py_coverage/&title=Hosting code coverage report for a project targeting multiple Python versions by Travis CI and Github Pages"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://naleraphael.github.io/2020/02/26/travis_ci_for_multi_py_coverage/&is_video=false&description=Hosting code coverage report for a project targeting multiple Python versions by Travis CI and Github Pages"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Hosting code coverage report for a project targeting multiple Python versions by Travis CI and Github Pages&body=Check out this article: https://naleraphael.github.io/2020/02/26/travis_ci_for_multi_py_coverage/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://naleraphael.github.io/2020/02/26/travis_ci_for_multi_py_coverage/&title=Hosting code coverage report for a project targeting multiple Python versions by Travis CI and Github Pages"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://naleraphael.github.io/2020/02/26/travis_ci_for_multi_py_coverage/&title=Hosting code coverage report for a project targeting multiple Python versions by Travis CI and Github Pages"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://naleraphael.github.io/2020/02/26/travis_ci_for_multi_py_coverage/&title=Hosting code coverage report for a project targeting multiple Python versions by Travis CI and Github Pages"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://naleraphael.github.io/2020/02/26/travis_ci_for_multi_py_coverage/&title=Hosting code coverage report for a project targeting multiple Python versions by Travis CI and Github Pages"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://naleraphael.github.io/2020/02/26/travis_ci_for_multi_py_coverage/&name=Hosting code coverage report for a project targeting multiple Python versions by Travis CI and Github Pages&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Hosting code coverage report for a project targeting multiple Python versions by Travis CI and Github Pages
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Little things matter</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2020-02-26T14:20:04.000Z" itemprop="datePublished">2020-02-26</time>
        
        (Updated: <time datetime="2020-02-27T06:58:56.664Z" itemprop="dateModified">2020-02-27</time>)
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link" href="/blog/tags/ci/">ci</a>, <a class="tag-link" href="/blog/tags/note/">note</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p>In the past few days, I was finding a solution for:</p>
<ol>
<li>running tests with code coverage for a project targeting multiple Python versions automatically</li>
<li>public and easily accessible coverage report</li>
</ol>
<p>To meet the requirements of point 1, we can run <a href="https://github.com/pytest-dev/pytest" target="_blank" rel="noopener">pytest</a> and <a href="https://github.com/pytest-dev/pytest-cov" target="_blank" rel="noopener">pytest-cov</a> (in which <a href="https://github.com/nedbat/coveragepy" target="_blank" rel="noopener">coverage.py</a> is integrated) on <a href="https://travis-ci.org/" target="_blank" rel="noopener">Travis CI</a>.</p>
<p>And thanks for the powerful <a href="https://github.com/nedbat/coveragepy" target="_blank" rel="noopener">coverage.py</a>, it is easy to generate a summarized report of code coverage for multiple Python versions by the following steps:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Just run this command repeatedly for each virtual environment ---</span></span><br><span class="line">$ COVERAGE_FILE=[name_of_coverage_file] python -mpytest --cov=[module_name] ./tests</span><br><span class="line"></span><br><span class="line"><span class="comment"># Then, use this command to combine data files.</span></span><br><span class="line"><span class="comment"># Note that name of data file should be in the format of `.coverage.[suffix]`</span></span><br><span class="line"><span class="comment"># ref: https://coverage.readthedocs.io/en/coverage-5.0.3/cmd.html#combining-data-files</span></span><br><span class="line">$ python -mcoverage combine</span><br></pre></td></tr></table></figure>
<p>As for point 2, it took me a while to make a decision. Though there are several existing awesome services like <a href="https://codecov.io/" target="_blank" rel="noopener">codecov</a>, <a href="https://coveralls.io/" target="_blank" rel="noopener">coverall</a>, I wonder if I could achieve it without those services.</p>
<p>To do that, I have to figure out a way to access data files of code coverage generated in each single CI job (environment). However, it’s unlike Jenkins and CircleCI, you cannot access/share artifacts generated by jobs by simply adding some operations in your <code>.travis.yml</code>. Though it’s a general concept of CI jobs and it’s also stated in <a href="https://docs.travis-ci.com/user/build-stages/#data-persistence-between-stages-and-jobs" target="_blank" rel="noopener">official documentation</a>:</p>
<blockquote>
<p>It is important to note that jobs do not share storage, as each job runs in a fresh VM or container. If your jobs need to share files (e.g., using build artifacts from the “Test” stage for deployment in the subsequent “Deploy” stage), you need to use an external storage mechanism such as S3 and a remote scp server.</p>
</blockquote>
<p>Oh… Third party service is still required?</p>
<p>After rethinking about this problem, it seems <a href="https://pages.github.com/" target="_blank" rel="noopener">Github Pages</a> is a good candidate as a solution. However, it requires some interactions between Travis CI and Github. Therefore, I started googling with keywords like <code>travis ci push back to github</code>.</p>
<p>Then, yeah, a good article emerged from the sea: <a href="https://gist.github.com/willprice/e07efd73fb7f13f917ea" target="_blank" rel="noopener">How to set up TravisCI for projects that push back to github</a></p>
<p>It solved a part of problem. The remaining one is: <span style="color: orange">“How can I access those data files of code coverage after each CI job is done?”</span><br>
It somehow seems that we are getting back to the starting point again. But, it isn’t.</p>
<p>Since we known that we could authorize Travis CI to push files back to our own Github repository, we could also playing with branches. Here is the strategy:</p>
<ol>
<li>Define a test stage containing jobs running tests on different Python version.</li>
<li>After a job is done, push the data file of code coverage back to specific branch.</li>
<li>While all tests are done, we enter to the next stage for combining data and generating report. In this stage, we checkout those data files from each branch for data storage.</li>
</ol>
<p>And I implemented it in <a href="https://github.com/NaleRaphael/travis-multi-py-coverage" target="_blank" rel="noopener">this repository</a>. All operations related to the strategy mentioned above are written in the file <a href="https://github.com/NaleRaphael/travis-multi-py-coverage/blob/master/.travis/utils.sh" target="_blank" rel="noopener">.travis/utils.sh</a>, and the workflows of running tests and generate report of code coverage are written in <a href="https://github.com/NaleRaphael/travis-multi-py-coverage/blob/master/.travis/runtests.sh" target="_blank" rel="noopener">.travis/runtests.sh</a> and <a href="https://github.com/NaleRaphael/travis-multi-py-coverage/blob/master/.travis/gen_report.sh" target="_blank" rel="noopener">.travis/gen_report.sh</a> respectively.</p>
<p>There are few things worth noting:</p>
<ul>
<li>
<p><code>create_branch_for_coverage</code><br>
We create <span style="color: orange">orphan branches</span> for tracking coverage files only. And the argument <code>--orphan</code> make these branches being history-independent to the main branch (master) of our project. It’s a cool technique for such purpose, and there are more <a href="https://stackoverflow.com/a/13203015" target="_blank" rel="noopener">cool use cases here</a>.</p>
</li>
<li>
<p><code>pull_branch_for_coverage</code><br>
By default, Travis CI pulls only <span style="color: orange">one branch</span> into docker container of a job (if it is triggered by <code>master</code> branch, then it pulls that branch).<br>
Therefore, to commit code coverage data to corresponding branch, we have to pull that branch to local first. And that’s why you can see this function is called in both <a href="https://github.com/NaleRaphael/travis-multi-py-coverage/blob/master/.travis/runtests.sh" target="_blank" rel="noopener">.travis/runtests.sh</a> and <a href="https://github.com/NaleRaphael/travis-multi-py-coverage/blob/master/.travis/gen_report.sh" target="_blank" rel="noopener">.travis/gen_report.sh</a>.</p>
</li>
<li>
<p><code>commit_artifacts</code><br>
Argument <code>--allow-empty</code> in command <code>git-commit</code> is necessary for this workflow, because there might be no changes in code coverage. e.g. commits for fixing typo, documentation…</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="title">commit_artifacts</span></span>() &#123;</span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">    git commit -q --allow-empty -m <span class="string">"Travis build: <span class="variable">$TRAVIS_BUILD_NUMBER</span>"</span></span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>use argument <code>-q</code> to silence output message<br>
<span style="color: red">For security reasons.</span> As <a href="https://gist.github.com/willprice/e07efd73fb7f13f917ea#gistcomment-1845535" target="_blank" rel="noopener">this comment</a> from that post created by willprice.</p>
</li>
</ul>
<p>After setting up all these things and push them to Github, Travis should be ready and work normally. And you can check the coverage report hosted on Github Pages of your repository (which should be <code>https://[your_github_user_name].github.io/[repo_name]</code>)</p>
<hr>
<p>In conclusion, it is a nice experience for me to explore more things related to continuous intergration and Git. Though it might not be a elegant solution, but it did make me learn many things from it.</p>

  </div>
</article>

    <div class="comments" id="comments">
        
    <script src="https://utteranc.es/client.js"
        repo="naleraphael/blog"
        issue-term="pathname"
        label="Comment"
        theme="icy-dark"
        crossorigin="anonymous"
        async>
    </script>


    </div>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/blog/">Home</a></li>
         
          <li><a href="/blog/about/">About</a></li>
         
          <li><a href="/blog/archives/">Writing</a></li>
         
          <li><a href="/blog/tags/">tags</a></li>
         
          <li><a href="/blog/search/">Search</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://naleraphael.github.io/2020/02/26/travis_ci_for_multi_py_coverage/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://naleraphael.github.io/2020/02/26/travis_ci_for_multi_py_coverage/&text=Hosting code coverage report for a project targeting multiple Python versions by Travis CI and Github Pages"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://naleraphael.github.io/2020/02/26/travis_ci_for_multi_py_coverage/&title=Hosting code coverage report for a project targeting multiple Python versions by Travis CI and Github Pages"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://naleraphael.github.io/2020/02/26/travis_ci_for_multi_py_coverage/&is_video=false&description=Hosting code coverage report for a project targeting multiple Python versions by Travis CI and Github Pages"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Hosting code coverage report for a project targeting multiple Python versions by Travis CI and Github Pages&body=Check out this article: https://naleraphael.github.io/2020/02/26/travis_ci_for_multi_py_coverage/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://naleraphael.github.io/2020/02/26/travis_ci_for_multi_py_coverage/&title=Hosting code coverage report for a project targeting multiple Python versions by Travis CI and Github Pages"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://naleraphael.github.io/2020/02/26/travis_ci_for_multi_py_coverage/&title=Hosting code coverage report for a project targeting multiple Python versions by Travis CI and Github Pages"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://naleraphael.github.io/2020/02/26/travis_ci_for_multi_py_coverage/&title=Hosting code coverage report for a project targeting multiple Python versions by Travis CI and Github Pages"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://naleraphael.github.io/2020/02/26/travis_ci_for_multi_py_coverage/&title=Hosting code coverage report for a project targeting multiple Python versions by Travis CI and Github Pages"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://naleraphael.github.io/2020/02/26/travis_ci_for_multi_py_coverage/&name=Hosting code coverage report for a project targeting multiple Python versions by Travis CI and Github Pages&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2020 naleraphael
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/blog/">Home</a></li>
         
          <li><a href="/blog/about/">About</a></li>
         
          <li><a href="/blog/archives/">Writing</a></li>
         
          <li><a href="/blog/tags/">tags</a></li>
         
          <li><a href="/blog/search/">Search</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->
<link rel="stylesheet" href="/blog/lib/font-awesome/css/all.min.css">
<link rel="stylesheet" href="/blog/lib/justified-gallery/css/justifiedGallery.min.css">

    <!-- jquery -->
<script src="/blog/lib/jquery/jquery.min.js"></script>
<script src="/blog/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>
<!-- clipboard -->

  <script src="/blog/lib/clipboard/clipboard.min.js"></script>
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight .code pre").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      target: function(trigger) {
        return trigger.nextElementSibling;
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>

<script src="/blog/js/main.js"></script>
<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->


</body>
</html>
