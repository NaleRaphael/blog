---
title: "Hosting code coverage report for a project targeting multiple Python versions by Travis CI and Github Pages"
date: 2020-02-26 22:20:04
tags:
- note
- ci
---

In the past few days, I was finding a solution for:
1. running tests with code coverage for a project targeting multiple Python versions automatically
2. public and easily accessible coverage report

To meet the requirements of point 1, we can run [pytest][link-pytest] and [pytest-cov][link-pytest_cov] (in which [coverage.py][link-coveragepy] is integrated) on [Travis CI][link-travis_ci].

And thanks for the powerful [coverage.py][link-coveragepy], it is easy to generate a summarized report of code coverage for multiple Python versions by the following steps:

```bash
# Just run this command repeatedly for each virtual environment ---
$ COVERAGE_FILE=[name_of_coverage_file] python -mpytest --cov=[module_name] ./tests

# Then, use this command to combine data files.
# Note that name of data file should be in the format of `.coverage.[suffix]`
# ref: https://coverage.readthedocs.io/en/coverage-5.0.3/cmd.html#combining-data-files
$ python -mcoverage combine
```

As for point 2, it took me a while to make a decision. Though there are several existing awesome services like [codecov][link-codecov], [coverall][link-coverall], I wonder if I could achieve it without those services.

To do that, I have to figure out a way to access data files of code coverage generated in each single CI job (environment). However, it's unlike Jenkins and CircleCI, you cannot access/share artifacts generated by jobs by simply adding some operations in your `.travis.yml`. Though it's a general concept of CI jobs and it's also stated in [official documentation][travis_ci_sharing_data]:

> It is important to note that jobs do not share storage, as each job runs in a fresh VM or container. If your jobs need to share files (e.g., using build artifacts from the “Test” stage for deployment in the subsequent “Deploy” stage), you need to use an external storage mechanism such as S3 and a remote scp server.

Oh... Third party service is still required?

After rethinking about this problem, it seems [Github Pages][link-ghpages] is a good candidate as a solution. However, it requires some interactions between Travis CI and Github. Therefore, I started googling with keywords like `travis ci push back to github`.

Then, yeah, a good article emerged from the sea: [How to set up TravisCI for projects that push back to github][willprice_travisci]

It solved a part of problem. The remaining one is: <span style="color: orange">"How can I access those data files of code coverage after each CI job is done?"</span>
It somehow seems that we are getting back to the starting point again. But, it isn't.

Since we known that we could authorize Travis CI to push files back to our own Github repository, we could also playing with branches. Here is the strategy:
1. Define a test stage containing jobs running tests on different Python version.
2. After a job is done, push the data file of code coverage back to specific branch.
3. While all tests are done, we enter to the next stage for combining data and generating report. In this stage, we checkout those data files from each branch for data storage.

And I implemented it in [this repository][gh_travis_demo]. All operations related to the strategy mentioned above are written in the file [.travis/utils.sh][gh_travis_demo_utils], and the workflows of running tests and generate report of code coverage are written in [.travis/runtests.sh][gh_travis_demo_runtests] and [.travis/gen_report.sh][gh_travis_demo_gen_report] respectively.


There are few things worth noting:
- `create_branch_for_coverage`
    We create <span style="color: orange">orphan branches</span> for tracking coverage files only. And the argument `--orphan` make these branches being history-independent to the main branch (master) of our project. It's a cool technique for such purpose, and there are more [cool use cases here][git_orphan_branch_use_cases].

- `pull_branch_for_coverage`
    By default, Travis CI pulls only <span style="color: orange">one branch</span> into docker container of a job (if it is triggered by `master` branch, then it pulls that branch).
    Therefore, to commit code coverage data to corresponding branch, we have to pull that branch to local first. And that's why you can see this function is called in both [.travis/runtests.sh][gh_travis_demo_runtests] and [.travis/gen_report.sh][gh_travis_demo_gen_report].

- `commit_artifacts`
    Argument `--allow-empty` in command `git-commit` is necessary for this workflow, because there might be no changes in code coverage. e.g. commits for fixing typo, documentation...
    ```bash
    commit_artifacts() {
        # ...
        git commit -q --allow-empty -m "Travis build: $TRAVIS_BUILD_NUMBER"
        # ...
    }
    ```

- use argument `-q` to silence output message
    <span style="color: red">For security reasons.</span> As [this comment](https://gist.github.com/willprice/e07efd73fb7f13f917ea#gistcomment-1845535) from that post created by willprice.

After setting up all these things and push them to Github, Travis should be ready and work normally. And you can check the coverage report hosted on Github Pages of your repository (which should be `https://[your_github_user_name].github.io/[repo_name]`)

---

In conclusion, it is a nice experience for me to explore more things related to continuous intergration and Git. Though it might not be a elegant solution, but it did make me learn many things from it.


[link-codecov]: https://codecov.io/
[link-pytest]: https://github.com/pytest-dev/pytest
[link-pytest_cov]: https://github.com/pytest-dev/pytest-cov
[link-coveragepy]: https://github.com/nedbat/coveragepy
[link-travis_ci]: https://travis-ci.org/
[link-codecov]: https://codecov.io/
[link-coverall]: https://coveralls.io/
[link-ghpages]: https://pages.github.com/
[travis_ci_sharing_data]: https://docs.travis-ci.com/user/build-stages/#data-persistence-between-stages-and-jobs
[willprice_travisci]: https://gist.github.com/willprice/e07efd73fb7f13f917ea
[gh_travis_demo]: https://github.com/NaleRaphael/travis-multi-py-coverage
[gh_travis_demo_utils]: https://github.com/NaleRaphael/travis-multi-py-coverage/blob/master/.travis/utils.sh
[gh_travis_demo_runtests]: https://github.com/NaleRaphael/travis-multi-py-coverage/blob/master/.travis/runtests.sh
[gh_travis_demo_gen_report]: https://github.com/NaleRaphael/travis-multi-py-coverage/blob/master/.travis/gen_report.sh
[git_orphan_branch_use_cases]: https://stackoverflow.com/a/13203015
